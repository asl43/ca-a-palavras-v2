<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ca√ßa-Palavras Premium + Ranking Nacional</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="manifest" href="#inline-manifest">
  <style>
    /* Seu CSS permanece 100% igual ‚Äî n√£o h√° altera√ß√µes visuais */
    :root{
        --bg:#f8fafc;
        --card:#ffffff;
        --primary:#1e3a8a;
        --accent:#3b82f6;
        --muted:#64748b;
        --success:#10b981;
        --warning:#f59e0b;
        --danger:#ef4444;
        --border:#e2e8f0;
        --shadow:rgba(30,58,138,0.08);
        --gradient-start:#667eea;
        --gradient-end:#764ba2;
        --text:#1e293b;
    }
    @media (prefers-contrast: high) {
        :root {
            --bg: #ffffff;
            --card: #f0f0f0;
            --primary: #000000;
            --text: #000000;
            --border: #000000;
            --accent: #0000ff;
            --success: #008000;
            --warning: #ff8c00;
            --danger: #ff0000;
        }
    }
    body.dark-mode {
        --bg:#0f172a;
        --card:#1e293b;
        --primary:#93c5fd;
        --accent:#60a5fa;
        --muted:#94a3b8;
        --border:#334155;
        --shadow:rgba(0,0,0,0.3);
        --gradient-start:#4c1d95;
        --gradient-end:#5b21b6;
        --text:#e2e8f0;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
        font-family:'Inter', sans-serif;
        background:linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
        min-height:100vh;
        padding:20px;
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:25px;
        transition:all 0.3s ease;
        color:var(--text);
    }
    .container{width:100%;max-width:1200px}
    header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom:10px;
        background:var(--card);
        backdrop-filter:blur(10px);
        padding:20px;
        border-radius:16px;
        box-shadow:0 20px 60px var(--shadow);
        border:1px solid var(--border);
    }
    h1{
        font-size:1.8rem;
        color:var(--primary);
        font-weight:800;
    }
    h2{font-size:1.25rem;color:var(--primary);font-weight:700}
    .card{
        background:var(--card);
        backdrop-filter:blur(10px);
        border-radius:20px;
        padding:25px;
        box-shadow:0 20px 60px var(--shadow);
        border:1px solid var(--border);
    }
    form{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    label{
        font-size:0.9rem;
        color:var(--primary);
        font-weight:600;
        margin-bottom:5px;
        display:block;
    }
    input,button,select{
        padding:12px 15px;
        border-radius:10px;
        border:2px solid var(--border);
        font-size:0.95rem;
        transition:all 0.3s ease;
        font-family:'Inter', sans-serif;
        background:var(--card);
        color:var(--text);
    }
    input:focus {
        border-color:var(--accent);
        outline:none;
        box-shadow:0 0 0 3px rgba(59, 130, 246, 0.2);
        transform:translateY(-2px);
    }
    button {
        cursor:pointer;
        font-weight:600;
        white-space:nowrap;
        transition:all 0.3s ease;
        border:none;
    }
    button:hover{
        transform:translateY(-2px);
        box-shadow:0 10px 25px rgba(0,0,0,0.2);
    }
    button:active{transform:translateY(0)}
    .full{grid-column:1/-1}
    .controls{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    .controls button:first-child {
        background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color:white;
        padding:12px 24px;
        font-size:1rem;
    }
    .controls button:not(:first-child) {
        background:var(--border);
        color:var(--primary);
    }
    .counter{
        font-weight:600;
        color:white;
        background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding:10px 20px;
        border-radius:12px;
        box-shadow:0 10px 25px rgba(102, 126, 234, 0.4);
    }
    .theme-toggle, .sound-toggle, .fullscreen-toggle{
        background:var(--card);
        border:2px solid var(--border);
        padding:10px 15px;
        border-radius:10px;
        cursor:pointer;
        font-size:1.2rem;
        transition:all 0.3s ease;
    }
    .theme-toggle:hover, .sound-toggle:hover, .fullscreen-toggle:hover{
        transform:scale(1.1);
        border-color:var(--accent);
    }
    .game-area{
        margin-top:0;
        display:grid;
        grid-template-columns:2fr 1fr;
        gap:25px;
    }
    .grid{
        display:grid;
        gap:4px;
        justify-content:center;
        padding:20px;
        background:var(--card);
        border-radius:16px;
        border:2px solid var(--border);
    }
    .cell{
        width:40px;
        height:40px;
        display:flex;
        align-items:center;
        justify-content:center;
        border-radius:8px;
        background:var(--card);
        color:var(--primary);
        font-weight:700;
        font-size:1.1rem;
        user-select:none;
        cursor:pointer;
        transition:all 0.2s ease;
        box-shadow:0 2px 8px var(--shadow);
        border:2px solid var(--border);
    }
    .cell:hover {
        background:var(--accent);
        color:white;
        transform:scale(1.1);
        box-shadow:0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .cell.selecting{
        background:var(--accent);
        color:white;
        transform:scale(1.1);
        animation:pulse 0.5s ease-in-out;
    }
    .cell.found{
        background:var(--success);
        color:#fff;
        animation:found 0.5s ease-in-out;
        border-color:var(--success);
    }
    @keyframes pulse{
        0%, 100%{transform:scale(1.1)}
        50%{transform:scale(1.2)}
    }
    @keyframes found{
        0%{transform:scale(1) rotate(0deg)}
        25%{transform:scale(1.3) rotate(-10deg)}
        50%{transform:scale(1.2) rotate(10deg)}
        75%{transform:scale(1.3) rotate(-5deg)}
        100%{transform:scale(1) rotate(0deg)}
    }
    .words-list{
        display:flex;
        flex-wrap:wrap;
        gap:10px;
        margin-top:15px;
    }
    .word{
        padding:10px 16px;
        border-radius:25px;
        background:var(--card);
        border:2px solid var(--border);
        font-size:0.9rem;
        font-weight:600;
        transition:all 0.3s ease;
        cursor:default;
    }
    .word:hover{
        transform:translateY(-2px);
        outline: 2px solid var(--accent);
    }
    .word.found{
        background:var(--success);
        color:#fff;
        border-color:transparent;
        text-decoration:line-through;
        animation:wordFound 0.6s ease-in-out;
    }
    @keyframes wordFound{
        0%{transform:scale(1)}
        50%{transform:scale(1.2) rotate(5deg)}
        100%{transform:scale(1)}
    }
    .game-header {
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:20px;
        padding-bottom:15px;
        border-bottom:2px solid var(--border);
    }
    .game-stats {
        display:flex;
        gap:15px;
        font-size:1rem;
        font-weight:600;
        flex-wrap:wrap;
    }
    .stat-badge{
        background:var(--card);
        padding:8px 16px;
        border-radius:20px;
        display:flex;
        align-items:center;
        gap:5px;
        box-shadow:0 2px 8px var(--shadow);
        border:2px solid var(--border);
    }
    .progress-bar{
        width:100%;
        height:8px;
        background:var(--border);
        border-radius:10px;
        overflow:hidden;
        margin:15px 0;
    }
    .progress-fill{
        height:100%;
        background:var(--success);
        transition:width 0.5s ease;
        border-radius:10px;
    }
    .leaderboard-list{
        margin-top:15px;
        padding:0;
        list-style:none;
    }
    .leaderboard-item{
        padding:15px;
        border-bottom:1px solid var(--border);
        display:flex;
        justify-content:space-between;
        align-items:center;
        transition:all 0.3s ease;
    }
    .leaderboard-item:hover{
        background:rgba(59, 130, 246, 0.05);
        transform:translateX(5px);
    }
    .leaderboard-item:nth-child(1){
        font-weight:700;
        background:rgba(255,193,7,0.2);
        border-radius:10px;
        border:2px solid rgba(255,193,7,0.5);
    }
    .leaderboard-item:nth-child(2){
        background:rgba(192,192,192,0.15);
        border-radius:8px;
    }
    .leaderboard-item:nth-child(3){
        background:rgba(205,127,50,0.15);
        border-radius:8px;
    }
    .time{
        color:var(--accent);
        font-weight:700;
        font-size:1.1rem;
    }
    .score-display{
        color:#fbbf24;
        font-weight:700;
        font-size:1.1rem;
    }
    .name{
        font-weight:600;
        color:var(--primary);
    }
    .game-controls{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
    }
    .game-controls button{
        padding:8px 16px;
        font-size:0.9rem;
        border-radius:8px;
    }
    .btn-pause{
        background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color:white;
    }
    .btn-giveup{
        background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color:white;
    }
    .btn-hint{
        background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color:white;
    }
    .btn-reset{
        background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color:white;
    }
    .btn-levels{
        background:linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color:white;
    }
    .btn-end-game{
        background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color:white;
    }
    .btn-skip{
        background:linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color:white;
    }
    .btn-share{
        background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color:white;
    }
    .toast{
        position:fixed;
        top:20px;
        right:20px;
        background:linear-gradient(135deg, #10b981 0%, #059669 100%);
        color:white;
        padding:15px 25px;
        border-radius:12px;
        box-shadow:0 10px 40px rgba(0,0,0,0.3);
        animation:slideIn 0.3s ease-in-out;
        z-index:1000;
        font-weight:600;
    }
    @keyframes slideIn{
        from{transform:translateX(400px);opacity:0}
        to{transform:translateX(0);opacity:1}
    }
    .particles{
        position:fixed;
        pointer-events:none;
        z-index:999;
    }
    .particle{
        position:absolute;
        width:10px;
        height:10px;
        background:var(--accent);
        border-radius:50%;
        animation:explode 0.8s ease-out forwards;
    }
    @keyframes explode{
        to{
            transform:translate(var(--tx), var(--ty));
            opacity:0;
        }
    }
    .confetti{
        position:fixed;
        width:10px;
        height:10px;
        pointer-events:none;
        z-index:999;
        animation:confettiFall 3s ease-out forwards;
    }
    @keyframes confettiFall{
        to{
            transform:translateY(100vh) rotate(720deg);
            opacity:0;
        }
    }
    .modal-overlay{
        position:fixed;
        top:0;
        left:0;
        right:0;
        bottom:0;
        background:rgba(0,0,0,0.7);
        backdrop-filter:blur(10px);
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:998;
        animation:fadeIn 0.3s ease;
    }
    @keyframes fadeIn{
        from{opacity:0}
        to{opacity:1}
    }
    .modal{
        background:var(--card);
        padding:30px;
        border-radius:20px;
        box-shadow:0 20px 60px rgba(0,0,0,0.5);
        animation:scaleIn 0.3s ease;
        max-width:600px;
        width:90%;
        max-height:80vh;
        overflow-y:auto;
        border:2px solid var(--border);
        position:relative;
    }
    @keyframes scaleIn{
        from{transform:scale(0.8);opacity:0}
        to{transform:scale(1);opacity:1}
    }
    .modal h2{
        margin-bottom:20px;
        color:var(--primary);
        text-align:center;
    }
    .modal-close{
        position:absolute;
        top:15px;
        right:15px;
        background:var(--danger);
        color:white;
        border:none;
        width:35px;
        height:35px;
        border-radius:50%;
        cursor:pointer;
        font-size:1.2rem;
        display:flex;
        align-items:center;
        justify-content:center;
    }
    .level-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
        gap:15px;
        margin-top:20px;
    }
    .level-card{
        background:var(--card);
        border:3px solid var(--border);
        border-radius:15px;
        padding:20px;
        cursor:pointer;
        transition:all 0.3s ease;
        text-align:center;
    }
    .level-card:hover{
        transform:translateY(-5px);
        border-color:var(--accent);
        box-shadow:0 10px 30px var(--shadow);
    }
    .level-card.locked{
        opacity:0.5;
        cursor:not-allowed;
    }
    .level-card.locked:hover{
        transform:none;
    }
    .level-difficulty{
        display:inline-block;
        padding:5px 12px;
        border-radius:20px;
        font-size:0.8rem;
        font-weight:700;
        margin-top:10px;
    }
    .difficulty-infantil{background:#ec4899;color:white}
    .difficulty-facil{background:#10b981;color:white}
    .difficulty-medio{background:#f59e0b;color:white}
    .difficulty-dificil{background:#ef4444;color:white}
    .difficulty-muito-dificil{background:#8b5cf6;color:white}
    .difficulty-extremo{background:#dc2626;color:white}
    .difficulty-biblia{background:#3b82f6;color:white}
    .history-list{
        list-style:none;
        padding:0;
    }
    .history-item{
        padding:15px;
        border-bottom:1px solid var(--border);
        display:flex;
        justify-content:space-between;
        align-items:center;
        transition:all 0.3s ease;
        background:var(--card);
        border-radius:12px;
        margin-bottom:10px;
    }
    .history-item:hover{
        background:rgba(59, 130, 246, 0.05);
        transform:translateX(5px);
    }
    .history-item.incomplete{
        border-left:5px solid var(--warning);
    }
    .history-item.complete{
        border-left:5px solid var(--success);
    }
    .history-info {
        display:grid;
        grid-template-columns:auto 1fr;
        gap:10px;
        align-items:center;
        flex-grow:1;
    }
    .history-info h4{
        margin:0;
        color:var(--primary);
        font-size:1rem;
        grid-column:2;
    }
    .history-info p{
        margin:5px 0 0 0;
        color:var(--muted);
        font-size:0.9rem;
        grid-column:2;
    }
    .history-icon{
        font-size:2rem;
        grid-row:span 2;
    }
    .history-time{
        font-size:1.3rem;
        font-weight:700;
        color:var(--accent);
    }
    .zen-badge{
        background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color:white;
        padding:8px 16px;
        border-radius:20px;
        font-size:0.9rem;
        font-weight:700;
        display:inline-flex;
        align-items:center;
        gap:5px;
    }
    .hint-count{
        background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color:white;
        padding:4px 10px;
        border-radius:12px;
        font-size:0.85rem;
        font-weight:700;
    }
    .combo-badge{
        position:fixed;
        top:50%;
        left:50%;
        transform:translate(-50%, -50%) scale(0);
        background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color:white;
        padding:20px 40px;
        border-radius:20px;
        font-size:2rem;
        font-weight:800;
        z-index:1001;
        animation:comboPop 1s ease-out;
        box-shadow:0 20px 60px rgba(0,0,0,0.5);
    }
    @keyframes comboPop{
        0%{transform:translate(-50%, -50%) scale(0)}
        50%{transform:translate(-50%, -50%) scale(1.2)}
        100%{transform:translate(-50%, -50%) scale(0)}
    }
    .achievement-badge{
        background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color:white;
        padding:6px 12px;
        border-radius:15px;
        font-size:0.8rem;
        font-weight:700;
        display:inline-flex;
        align-items:center;
        gap:5px;
        margin:5px;
    }
    .stats-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
        gap:15px;
        margin-top:20px;
    }
    .stat-card{
        background:var(--card);
        border:2px solid var(--border);
        border-radius:12px;
        padding:15px;
        text-align:center;
    }
    .stat-value{
        font-size:2rem;
        font-weight:800;
        color:var(--accent);
    }
    .stat-label{
        color:var(--muted);
        font-size:0.9rem;
        margin-top:5px;
    }
    .empty-state{
        text-align:center;
        padding:40px 20px;
        color:var(--muted);
    }
    .empty-state-icon{
        font-size:4rem;
        margin-bottom:15px;
    }
    .tutorial-overlay{
        position:fixed;
        top:0;
        left:0;
        right:0;
        bottom:0;
        background:rgba(0,0,0,0.9);
        z-index:1002;
        display:flex;
        align-items:center;
        justify-content:center;
    }
    .tutorial-content{
        background:var(--card);
        padding:40px;
        border-radius:20px;
        max-width:600px;
        text-align:center;
        box-shadow:0 20px 60px rgba(0,0,0,0.5);
    }
    .tutorial-step{
        margin:20px 0;
        padding:20px;
        background:rgba(59, 130, 246, 0.1);
        border-radius:12px;
        border-left:4px solid var(--accent);
        text-align:left;
    }
    .category-section{
        margin-bottom:30px;
    }
    .category-title{
        font-size:1.5rem;
        color:var(--primary);
        margin-bottom:15px;
        padding-bottom:10px;
        border-bottom:3px solid var(--accent);
        display:flex;
        align-items:center;
        gap:10px;
    }
    .screen {
        display: none;
        width: 100%;
        max-width: 900px;
    }
    .screen.active {
        display: block;
    }
    .results-section h3 {
        color: var(--primary);
        border-bottom: 2px solid var(--border);
        padding-bottom: 10px;
        margin-top: 25px;
        margin-bottom: 15px;
        font-size: 1.5rem;
    }
    .results-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
    }
    .results-buttons button {
        padding: 15px 30px;
        font-size: 1.1rem;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
    }
    .stars {
        color: #fbbf24;
        font-size: 1.2rem;
        letter-spacing: 2px;
        margin-top: 5px;
    }
    #rankInfo {
        font-size: 1.1rem;
        color: var(--accent);
        font-weight: 700;
        margin-top: 10px;
    }
    @media (max-width:768px){
        .game-area{grid-template-columns:1fr;gap:20px}
        .grid{padding:10px}
        .cell{width:32px;height:32px;font-size:0.95rem}
        .words-list{justify-content:center}
        .word{font-size:0.85rem;padding:8px 12px}
        form{grid-template-columns:1fr}
        header{flex-direction:column;gap:15px;text-align:center}
        h1{font-size:1.4rem}
        .counter{width:100%;text-align:center}
        .controls{flex-direction:column;gap:10px;align-items:stretch}
        .game-stats{flex-direction:column;gap:8px}
        .toast{right:10px;left:10px;top:10px}
        .modal{padding:20px;width:95%}
        .level-grid{grid-template-columns:1fr}
        .game-controls{justify-content:center;}
        .results-buttons {flex-direction: column;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéØ Ca√ßa-Palavras Premium</h1>
      <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap">
        <button class="sound-toggle" id="soundToggle" title="Alternar Som">üîä</button>
        <button class="theme-toggle" id="themeToggle" title="Alternar Tema">üåô</button>
        <button class="fullscreen-toggle" id="fullscreenToggle" title="Tela Cheia">‚õ∂</button>
        <div class="counter">üìä Registros: <span id="totalCount">0</span></div>
      </div>
    </header>
    <section class="card screen active" id="registerScreen">
      <h2 style="margin-bottom:15px">üìù Registrar Participante</h2>
      <form id="cadForm">
        <div>
          <label for="nome">üë§ Nome completo *</label>
          <input id="nome" name="nome" required placeholder="Seu nome para o Ranking" />
        </div>
        <div>
          <label for="dob">üéÇ Data de nascimento (opcional)</label>
          <input id="dob" name="dob" type="date" placeholder="Opcional" />
        </div>
        <div class="full">
          <label for="datetime">üìÖ Data e hora (Registro)</label>
          <input id="datetime" name="datetime" type="datetime-local" required />
        </div>
        <div class="full" style="margin-top:10px;color:var(--muted);font-size:0.85rem;">
          <p>üîí Seus dados s√£o usados apenas para exibi√ß√£o no ranking. N√£o compartilhamos com terceiros.</p>
        </div>
        <div class="full controls">
          <button type="submit" id="submitBtn">‚ú® Registrar e Iniciar Jogo</button>
          <button type="button" id="openGameBtn">üéÆ Jogar Sem Registrar</button>
        </div>
      </form>
      <div style="margin-top:20px;color:var(--muted);border-top:2px solid var(--border);padding-top:15px;font-size:0.9rem;">
        <strong>üìå √öltimos registros:</strong> <span id="lastEntries">Nenhum ainda</span>
      </div>
    </section>
    <section class="card screen" id="leaderboardCard">
        <h2 style="margin-bottom:5px">üèÜ Ranking Nacional de L√≠deres</h2>
        <div id="leaderboardStatus" style="color:var(--muted);font-size:0.9rem;margin-top:10px" aria-live="polite">Carregando ranking...</div>
        <ul id="leaderboardList" class="leaderboard-list" aria-live="polite"></ul>
        <button id="refreshLeaderboard" style="margin-top:15px;background:var(--accent);color:white;padding:10px 20px;border-radius:8px;width:100%;cursor:pointer">üîÑ Atualizar Ranking</button>
        <div class="controls" style="margin-top: 15px;">
             <button type="button" id="statsBtnInitial" style="background:var(--warning);color:white">üìä Estat√≠sticas</button>
             <button type="button" id="historyBtnInitial" style="background:var(--primary);color:white">üìú Ver Hist√≥rico</button>
             <button type="button" id="clearBtnInitial" style="background:var(--danger);color:white">üóëÔ∏è Limpar Dados</button>
        </div>
    </section>
    <section class="card screen" id="gameScreen">
        <div class="game-header">
            <div>
                <h2 id="gameTitle">üéÆ Ca√ßa-Palavras: N√≠vel 1</h2>
                <div style="display:flex;gap:10px;margin-top:5px;flex-wrap:wrap">
                    <span id="zenBadge" style="display:none" class="zen-badge">üßò Modo Zen</span>
                    <span id="comboDisplay" style="display:none" class="achievement-badge">üî• Combo: <span id="comboCount">0</span></span>
                    <span id="scoreDisplay" class="achievement-badge">‚≠ê Pontos: <span id="currentScore">0</span></span>
                </div>
            </div>
            <div class="game-controls">
                <button class="btn-levels" id="levelsBtn">üìã N√≠veis</button>
                <button class="btn-pause" id="pauseBtn">‚è∏Ô∏è Pausar</button>
                <button class="btn-hint" id="hintBtn">üí° Dica (<span class="hint-count" id="hintCount">3</span>)</button>
                <button class="btn-skip" id="skipLevelBtn">‚è≠Ô∏è Pular N√≠vel</button>
                <button class="btn-giveup" id="giveUpBtn">‚ùå Desistir do N√≠vel</button>
                <button class="btn-end-game" id="endGameBtn">‚èπÔ∏è Finalizar Jogo</button>
                <button class="btn-share" id="shareResultsBtn">üì§ Compartilhar</button>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
        <div class="game-stats">
            <div class="stat-badge">
                <span>üéØ</span>
                <span id="levelDisplay">N√≠vel 1</span>
            </div>
            <div class="stat-badge">
                <span>‚è±Ô∏è</span>
                <span id="timeDisplay" aria-live="polite">0.00s</span>
            </div>
            <div class="stat-badge">
                <span>‚úÖ</span>
                <span id="foundCount" aria-live="polite">0 / 0</span>
            </div>
            <div class="stat-badge">
                <span>üìà</span>
                <span id="accuracyDisplay" aria-live="polite">100%</span>
            </div>
        </div>
      <div class="game-area">
        <div>
          <div id="gridWrap"></div>
        </div>
        <div style="min-width:220px">
          <strong style="font-size:1.1rem;color:var(--primary)">üìù Palavras a Encontrar</strong>
          <div id="words" class="words-list" aria-live="polite" role="region" aria-label="Palavras a encontrar"></div>
          <div style="margin-top:25px;padding:15px;background:rgba(59, 130, 246, 0.1);border-radius:12px;border-left:4px solid var(--accent)">
                <strong style="color:var(--accent)">üí° Dica:</strong>
                <p style="margin-top:8px;color:var(--muted);font-size:0.85rem">
                    <strong>Atalhos:</strong> ESC = Pausar | H = Dica | F = Tela Cheia
                </p>
            </div>
            <div id="achievementsDisplay" style="margin-top:15px" aria-live="polite"></div>
        </div>
      </div>
    </section>
    <section class="card screen" id="resultsScreen">
        <h2 style="font-size:2rem;text-align:center;margin-bottom:10px">üéâ FIM DE JOGO!</h2>
        <div id="finalGameStats" style="text-align:center;margin-bottom:20px;padding:20px;background:rgba(16, 185, 129, 0.1);border-radius:15px;border:2px solid var(--success)">
            <h3 style="color:var(--success);margin-bottom:10px">Seu Desempenho</h3>
            <p style="font-size:1.1rem;font-weight:600">Pontos Totais da Sess√£o: <span style="color:var(--accent);font-size:1.5rem" id="finalSessionScore">0</span></p>
            <p style="font-size:1.1rem;font-weight:600">Tempo de √öltimo N√≠vel: <span style="color:var(--accent);font-size:1.5rem" id="finalLastLevelTime">0.00s</span></p>
        </div>
        <div class="results-section">
            <h3 style="display:flex;align-items:center;gap:10px">üìä Suas Estat√≠sticas</h3>
            <div id="resultsStatsGrid" class="stats-grid"></div>
            <div style="margin-top:30px">
                <h4 style="color:var(--primary);margin-bottom:10px;font-size:1.2rem">üèÜ Conquistas Desbloqueadas</h4>
                <div id="resultsAchievementsDisplay" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center"></div>
            </div>
        </div>
        <div class="results-section">
            <h3 style="display:flex;align-items:center;gap:10px">üèÜ Ranking Nacional</h3>
            <div id="resultsLeaderboardStatus" style="color:var(--muted);font-size:0.9rem;margin-top:10px" aria-live="polite">Carregando ranking...</div>
            <ul id="resultsLeaderboardList" class="leaderboard-list" aria-live="polite"></ul>
            <button id="refreshLeaderboardResults" style="margin-top:15px;background:var(--accent);color:white;padding:10px 20px;border-radius:8px;width:100%;cursor:pointer">üîÑ Atualizar Ranking</button>
        </div>
        <div class="results-section">
            <h3 style="display:flex;align-items:center;gap:10px">üìú Hist√≥rico de Partidas</h3>
            <ul id="resultsHistoryList" class="history-list" aria-live="polite"></ul>
            <button onclick="clearHistoryResults()" style="background:var(--danger);color:white;padding:10px 20px;border-radius:8px;cursor:pointer;width:100%;margin-top:15px">üóëÔ∏è Limpar Hist√≥rico Completo</button>
        </div>
        <div class="results-buttons">
            <button style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white" onclick="startNewGameFromResults()">‚ñ∂Ô∏è Novo Jogo</button>
            <button style="background:var(--muted);color:white" onclick="showScreen('registerScreen')">üè† Tela Inicial</button>
        </div>
    </section>
    <div id="modalContainer"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // üîß CONFIGURA√á√ïES GLOBAIS
    const STORAGE_KEY = 'cadastros_ca';
    const HISTORY_KEY = 'game_history';
    const THEME_KEY = 'dark_mode';
    const PROGRESS_KEY = 'game_progress';
    const SOUND_KEY = 'sound_enabled';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxRe-8oG7fyZEMjN6unJcw7QMFpzHOW6lg7dCgQrhX9D_uHq-IQMpbXLfIrTtKLBHxI/exec';
    const GAME_LEVELS = [
        { title: 'Infantil 1: Desenhos Animados', size: 10, words: ['MICKEY', 'ELSA', 'BOB', 'PEPPA', 'SONIC', 'PIKACHU', 'DORA', 'HULK'], difficulty: 'Infantil', color: '#ec4899', icon: 'üé®', category: 'infantil' },
        { title: 'Infantil 2: Super Her√≥is', size: 10, words: ['BATMAN', 'CHAPOLIN', 'SUPERMAN', 'CAPITAO', 'MAGNETO', 'FLASH', 'THOR', 'PANTERA'], difficulty: 'Infantil', color: '#ec4899', icon: 'ü¶∏', category: 'infantil' },
        { title: 'Infantil 3: Contos de Fadas', size: 11, words: ['CINDERELA', 'FROZEN', 'ARIEL', 'AURORA', 'FERA', 'PRINCESA', 'DRAGAO', 'CASTELO', 'MAGIA'], difficulty: 'Infantil', color: '#ec4899', icon: 'üë∏', category: 'infantil' },
        { title: 'Brasil 1: For√ßas Armadas', size: 12, words: ['BRASIL', 'AMAZONAS', 'MANAUS', 'POLICIA', 'SEGURANCA', 'FORCA', 'PATENTE', 'ALERTA', 'VIATURA', 'PATRIA'], difficulty: 'F√°cil', color: '#10b981', icon: 'üõ°Ô∏è', category: 'brasil' },
        { title: 'Brasil 2: Estados', size: 12, words: ['ACRE', 'BAHIA', 'CEARA', 'GOIAS', 'PARANA', 'PERNAMBUCO', 'RIOGRANDE', 'SERGIPE', 'TOCANTINS', 'MARANHAO'], difficulty: 'F√°cil', color: '#10b981', icon: 'üáßüá∑', category: 'brasil' },
        { title: 'Brasil 3: Culin√°ria', size: 13, words: ['FEIJOADA', 'ACARAJ√â', 'COXINHA', 'P√ÉODEQUEIJO', 'MOQUECA', 'BRIGADEIRO', 'FAROFA', 'TAPIOCA', 'A√áA√ç', 'CHURRASCO'], difficulty: 'F√°cil', color: '#10b981', icon: 'üç≤', category: 'brasil' },
        { title: 'Tecnologia 1: Programa√ß√£o', size: 14, words: ['PROGRAMA', 'ALGORITMO', 'COMPUTADOR', 'INTERNET', 'HARDWARE', 'SOFTWARE', 'APLICACAO', 'SERVIDOR', 'SEGURANCA', 'ENGENHEIRO', 'DATABASE', 'PYTHON'], difficulty: 'M√©dio', color: '#f59e0b', icon: 'üíª', category: 'tecnologia' },
        { title: 'Tecnologia 2: Redes Sociais', size: 14, words: ['FACEBOOK', 'INSTAGRAM', 'TWITTER', 'TIKTOK', 'YOUTUBE', 'WHATSAPP', 'TELEGRAM', 'LINKEDIN', 'PINTEREST', 'SNAPCHAT', 'REDDIT', 'DISCORD'], difficulty: 'M√©dio', color: '#f59e0b', icon: 'üì±', category: 'tecnologia' },
        { title: 'Tecnologia 3: Inova√ß√£o', size: 15, words: ['INTELIGENCIA', 'ARTIFICIAL', 'ROBOTICA', 'DRONES', 'NANOTECNOLOGIA', 'CRIPTO', 'BLOCKCHAIN', 'REALIDADE', 'VIRTUAL', 'AUTOMA√á√ÉO', 'BIGDATA', 'NUVEM'], difficulty: 'M√©dio', color: '#f59e0b', icon: 'üöÄ', category: 'tecnologia' },
        { title: 'Mundo 1: Cidades', size: 16, words: ['BRASILIA', 'SAOPAULO', 'RIODEJANEIRO', 'PARIS', 'TOKIO', 'LONDRES', 'NYORQUE', 'SIDNEY', 'PEQUIM', 'MOSCOU', 'DUBAI', 'BERLIM', 'LISBOA', 'MADRI'], difficulty: 'Dif√≠cil', color: '#ef4444', icon: 'üåç', category: 'mundo' },
        { title: 'Mundo 2: Pa√≠ses', size: 16, words: ['BRASIL', 'ARGENTINA', 'PORTUGAL', 'ESPANHA', 'ALEMANHA', 'ITALIA', 'FRANCA', 'JAPAO', 'CHINA', 'AUSTRALIA', 'CANADA', 'MEXICO', 'INDIA', 'RUSSIA'], difficulty: 'Dif√≠cil', color: '#ef4444', icon: 'üó∫Ô∏è', category: 'mundo' },
        { title: 'Mundo 3: Idiomas', size: 17, words: ['PORTUGUES', 'INGLES', 'ESPANHOL', 'FRANCES', 'ALEMAO', 'ITALIANO', 'RUSSO', 'CHINES', 'JAPONES', 'ARABE', 'COREANO', 'GREGO', 'LATIM', 'HEBRAICO'], difficulty: 'Dif√≠cil', color: '#ef4444', icon: 'üó£Ô∏è', category: 'mundo' },
        { title: 'Mundo 4: Capitais', size: 17, words: ['LONDRES', 'PARIS', 'ROMA', 'BERLIM', 'TOKIO', 'PEQUIM', 'MOSCOU', 'OTTAWA', 'MEXICO', 'LIMA', 'SANTIAGO', 'BUENOSAIRES', 'CANBERRA', 'PRETORIA'], difficulty: 'Dif√≠cil', color: '#ef4444', icon: 'üèôÔ∏è', category: 'mundo' },
        { title: 'B√≠blia 1: Livros do Pentateuco', size: 15, words: ['G√äNESIS', '√äXODO', 'LEV√çTICO', 'N√öMEROS', 'DEUTERON√îMIO'], difficulty: 'B√≠blia', color: '#3b82f6', icon: 'üìñ', category: 'biblia' },
        { title: 'B√≠blia 2: Personagens do Velho Testamento', size: 17, words: ['ABRA√ÉO', 'MOIS√âS', 'NO√â', 'ISAQUE', 'JAC√ì', 'JOS√â', 'DAVI', 'ELIAS', 'RUTE'], difficulty: 'B√≠blia', color: '#3b82f6', icon: 'üßî', category: 'biblia' },
        { title: 'B√≠blia 3: Personagens do Novo Testamento', size: 18, words: ['JESUS', 'PAULO', 'PEDRO', 'JO√ÉO', 'MARIA', 'JUDAS', 'MATEUS', 'LUCAS', 'MARCOS', 'TITO'], difficulty: 'B√≠blia', color: '#3b82f6', icon: 'üòá', category: 'biblia' },
        { title: 'B√≠blia 4: Cidades e Lugares', size: 19, words: ['JERUSAL√âM', 'BEL√âM', 'NAZAR√â', 'JERIC√ì', 'GALILEIA', 'ISRAEL', 'JORD√ÉO', 'EGITO', 'EDEN'], difficulty: 'B√≠blia', color: '#3b82f6', icon: 'üïç', category: 'biblia' },
        { title: 'B√≠blia 5: Conceitos e Termos', size: 20, words: ['SALVA√á√ÉO', 'EVANGELHO', 'F√â', 'GRA√áA', 'AMOR', 'ORA√á√ÉO', 'C√âU', 'INFERNO', 'LIVRO', 'PALAVRA'], difficulty: 'B√≠blia', color: '#3b82f6', icon: 'üôè', category: 'biblia' },
        { title: 'Natureza 1: Animais', size: 18, words: ['ELEFANTE', 'RINOCERONTE', 'HIPOPOTAMO', 'GIRAFA', 'LEOPARDO', 'CROCODILO', 'TUBARAO', 'AGUIA', 'PINGUIM', 'GOLFINHO', 'BORBOLETA', 'FORMIGA', 'CACHORRO', 'TARTARUGA'], difficulty: 'Muito Dif√≠cil', color: '#8b5cf6', icon: 'ü¶Å', category: 'natureza' },
        { title: 'Natureza 2: Flores', size: 18, words: ['ORQUIDEA', 'GIRASSOL', 'MARGARIDA', 'TULIPA', 'JASMIM', 'LAVANDA', 'HORTENCIA', 'AZALEIA', 'BEGONIA', 'CRISANTEMO', 'DALIA', 'GARDENIA', 'HIBISCO', 'PETUNIA'], difficulty: 'Muito Dif√≠cil', color: '#8b5cf6', icon: 'üå∫', category: 'natureza' },
        { title: 'Natureza 3: Clima', size: 19, words: ['TEMPESTADE', 'FURACAO', 'TSUNAMI', 'TERREMOTO', 'VULCAO', 'GEADA', 'TROVOADA', 'VENTANIA', 'CHUVA', 'SOL', 'NEVE', 'GRANIZO', 'NUVEM', 'ARCOIRIS', 'UMIDADE'], difficulty: 'Muito Dif√≠cil', color: '#8b5cf6', icon: '‚òÄÔ∏è', category: 'natureza' },
        { title: 'Extremo 1: Ci√™ncias', size: 20, words: ['ASTRONOMIA', 'BIOLOGIA', 'QUIMICA', 'FISICA', 'MATEMATICA', 'GEOLOGIA', 'ECOLOGIA', 'GENETICA', 'NEUROCIENCIA', 'PALEONTOLOGIA', 'ZOOLOGIA', 'BOTANICA', 'MICROBIOLOGIA', 'ANTROPOLOGIA', 'ARQUEOLOGIA'], difficulty: 'Extremo', color: '#dc2626', icon: 'üî¨', category: 'extremo' },
        { title: 'Extremo 2: Profiss√µes', size: 20, words: ['ENGENHEIRO', 'ARQUITETO', 'ADVOGADO', 'MEDICO', 'ENFERMEIRO', 'PROFESSOR', 'DENTISTA', 'VETERINARIO', 'PSICOLOGO', 'FARMACEUTICO', 'FISIOTERAPEUTA', 'NUTRICIONISTA', 'CONTADOR', 'PROGRAMADOR', 'DESIGNER'], difficulty: 'Extremo', color: '#dc2626', icon: 'üíº', category: 'extremo' },
        { title: 'Extremo 3: Qu√≠mica', size: 21, words: ['ELETRONEGATIVIDADE', 'ESTEQUIOMETRIA', 'TERMODINAMICA', 'FOTOQUIMICA', 'CRISTALOGRAFIA', 'CROMATOGRAFIA', 'POLIMERO', 'CATALISADOR', 'REACAO', 'ATOMO', 'MOLECULA', 'ISOTOPO', 'ELETRON', 'PROTON', 'NEUTRO'], difficulty: 'Extremo', color: '#dc2626', icon: 'üß™', category: 'extremo' },
        { title: 'Extremo 4: Geopol√≠tica', size: 21, words: ['GEOPOLITICA', 'DIPLOMACIA', 'SOBERANIA', 'NACIONALISMO', 'GLOBALIZACAO', 'IDEOLOGIA', 'TERRORISMO', 'GUERRA', 'PAZ', 'ONU', 'OTAN', 'UNIAOEUROPEIA', 'MERCOSUL', 'CONFLITO', 'ACORDO'], difficulty: 'Extremo', color: '#dc2626', icon: 'üåê', category: 'extremo' }
    ];

    // üß† VARI√ÅVEIS DE JOGO
    let GRID_SIZE = GAME_LEVELS[0].size;
    let WORDS = GAME_LEVELS[0].words;
    let currentRowId = null; 
    let startTime = null;
    let timerInterval = null;
    let currentUserName = null;
    let currentLevel = 0;
    let isPaused = false;
    let hintsRemaining = 3;
    let pausedTime = 0;
    let isZenMode = false;
    let sessionStart = Date.now();
    let soundEnabled = true;
    let comboCount = 0;
    let lastWordTime = 0;
    let gameScore = 0;
    let totalScore = 0;
    let correctSelections = 0;
    let totalSelections = 0;
    let achievements = [];
    let unlockedLevels = 1;
    let grid = [];
    let placedWords = [];
    let selection = null;
    let found = new Set();
    let lastLevelTimeTaken = 0;
    let hasCompletedLevelOne = false;
    let playerStars = 0;

    // ‚ú® UTILIT√ÅRIOS
    const $ = id => document.getElementById(id);
    const sounds = {
        click: () => playBeep(800, 0.1, 0.05),
        success: () => playBeep(1000, 0.2, 0.1),
        error: () => playBeep(300, 0.3, 0.1),
        levelUp: () => {
            playBeep(523, 0.1, 0.1);
            setTimeout(() => playBeep(659, 0.1, 0.1), 100);
            setTimeout(() => playBeep(784, 0.2, 0.15), 200);
        },
        combo: () => {
            for(let i = 0; i < 3; i++) {
                setTimeout(() => playBeep(1000 + i * 200, 0.1, 0.08), i * 80);
            }
        }
    };

    function playBeep(frequency, duration, volume) {
        if (!soundEnabled) return;
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        } catch (e) {
            console.log('√Åudio n√£o suportado');
        }
    }

    function calculateStars(timeTaken, hintsUsed, accuracy) {
        if (isZenMode) return 0;
        let stars = 0;
        if (timeTaken <= 30) stars++;
        if (timeTaken <= 60) stars++;
        if (hintsUsed === 0) stars++;
        if (accuracy >= 90) stars++;
        return Math.min(3, stars);
    }

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        $(screenId).classList.add('active');
        window.scrollTo({top: 0, behavior: 'smooth'});
        if (screenId === 'registerScreen') {
            stopTimer();
            currentRowId = null;
            loadLeaderboard();
        }
        if (screenId === 'resultsScreen') {
            loadResultsScreen();
        }
    }

    function loadResultsScreen() {
        $('finalSessionScore').textContent = totalScore;
        $('finalLastLevelTime').textContent = isZenMode ? '‚ôæÔ∏è Zen' : `${lastLevelTimeTaken.toFixed(2)}s`;
        const history = loadGameHistory();
        hasCompletedLevelOne = history.some(g => g.level === 0 && g.completed);
        if (hasCompletedLevelOne) {
            loadLeaderboard('results');
        } else {
            $('resultsLeaderboardStatus').textContent = '‚ö†Ô∏è Conclua o N√≠vel 1 para entrar no Ranking Nacional!';
            $('resultsLeaderboardList').innerHTML = '<li class="leaderboard-item">Ranking indispon√≠vel at√© a conclus√£o do primeiro n√≠vel.</li>';
        }

        const progress = loadProgress();
        const totalGames = history.length;
        const completedGames = history.filter(g => g.completed).length;
        const totalTime = history.reduce((sum, g) => sum + (g.time || 0), 0);
        const avgTime = totalGames > 0 ? (totalTime / totalGames).toFixed(2) : 0;
        const bestTime = history.length > 0 ? Math.min(...history.filter(g => g.time > 0 && g.completed).map(g => g.time || 999)).toFixed(2) : 0;
        const accuracy = totalSelections > 0 ? (correctSelections / totalSelections * 100).toFixed(1) : 100;
        $('resultsStatsGrid').innerHTML = `
            <div class="stat-card"><div class="stat-value">${totalGames}</div><div class="stat-label">Partidas Jogadas</div></div>
            <div class="stat-card"><div class="stat-value">${completedGames}</div><div class="stat-label">Completadas</div></div>
            <div class="stat-card"><div class="stat-value">${progress.totalScore || 0}</div><div class="stat-label">Pontos Total</div></div>
            <div class="stat-card"><div class="stat-value">${avgTime}s</div><div class="stat-label">Tempo M√©dio</div></div>
            <div class="stat-card"><div class="stat-value">${bestTime}s</div><div class="stat-label">Melhor Tempo</div></div>
            <div class="stat-card"><div class="stat-value">${accuracy}%</div><div class="stat-label">Precis√£o</div></div>
        `;
        if (achievements.length === 0) {
            $('resultsAchievementsDisplay').innerHTML = '<div class="empty-state"><p style="color:var(--muted)">Jogue para desbloquear conquistas!</p></div>';
        } else {
            $('resultsAchievementsDisplay').innerHTML = achievements.map(ach => `<div class="achievement-badge">${ach.icon} ${ach.title}</div>`).join('');
        }
        const htmlHistory = history.slice(0, 10).map(game => {
            const date = new Date(game.date);
            const dateStr = date.toLocaleDateString('pt-BR');
            const timeStr = date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            const levelInfo = GAME_LEVELS[game.level] || GAME_LEVELS[0];
            const completionClass = game.completed ? 'complete' : 'incomplete';
            const completionText = game.completed ? '‚úÖ Completo' : (game.foundWords > 0 ? '‚ö†Ô∏è Incompleto' : '‚ùå Desistiu');
            const stars = game.stars || 0;
            const starsDisplay = '‚≠ê'.repeat(stars).padEnd(3, '‚òÜ');
            const playerName = game.playerName || 'Desconhecido';
            return `
                <li class="history-item ${completionClass}">
                    <div class="history-icon">${game.completed ? '‚úÖ' : '‚ùå'}</div>
                    <div class="history-info">
                        <h4>${levelInfo.title} (${playerName})</h4>
                        <p>${game.foundWords}/${game.totalWords} palavras ‚Ä¢ ${game.score || 0} pts ‚Ä¢ ${completionText}
                            ${game.zenMode ? ' ‚Ä¢ <span class="zen-badge" style="font-size:0.8rem;padding:3px 8px">üßò Zen</span>' : ''}
                            <br><span class="stars">${starsDisplay}</span>
                        </p>
                        <p style="font-size:0.85rem">${dateStr} √†s ${timeStr}</p>
                    </div>
                    <div class="history-time">${game.zenMode ? '_FILENO' : game.time ? game.time.toFixed(2) + 's' : '-'}</div>
                </li>
            `;
        }).join('');
        $('resultsHistoryList').innerHTML = htmlHistory || '<div class="empty-state"><p style="color:var(--muted)">Nenhuma partida registrada ainda.</p></div>';
    }

    function startNewGameFromResults() {
        showScreen('gameScreen');
        currentLevel = 0;
        resetGameSession();
        initGame(currentLevel);
        showToast(`üéÆ Novo Jogo iniciado!`, 'success');
        sounds.levelUp();
    }

    function clearHistoryResults() {
        if (confirm('üóëÔ∏è Deseja realmente limpar todo o hist√≥rico de partidas?\nSeus dados locais (incluindo nome e partidas) ser√£o apagados permanentemente.')) {
            localStorage.removeItem(HISTORY_KEY);
            showToast('üóëÔ∏è Hist√≥rico limpo com sucesso!', 'success');
            loadResultsScreen();
        }
    }

    function loadTheme() {
        const isDark = localStorage.getItem(THEME_KEY) === 'true';
        if (isDark) {
            document.body.classList.add('dark-mode');
            $('themeToggle').textContent = '‚òÄÔ∏è';
        }
    }

    function toggleTheme() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem(THEME_KEY, isDark);
        $('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        showToast(isDark ? 'üåô Modo Escuro Ativado' : '‚òÄÔ∏è Modo Claro Ativado', 'success');
        sounds.click();
    }

    function toggleSound() {
        soundEnabled = !soundEnabled;
        localStorage.setItem(SOUND_KEY, soundEnabled);
        $('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
        showToast(soundEnabled ? 'üîä Som Ativado' : 'üîá Som Desativado', 'success');
        if(soundEnabled) sounds.success();
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                showToast('‚ö†Ô∏è Erro ao ativar tela cheia', 'error');
            });
        } else {
            document.exitFullscreen();
        }
    }

    function calculateScore(timeTaken, hintsUsed, level) {
        const baseScore = 1000;
        const timeBonus = Math.max(0, 500 - timeTaken * 2);
        const hintPenalty = hintsUsed * 100;
        const levelMultiplier = (level + 1) * 1.5;
        const comboBonus = comboCount * 50;
        return Math.round((baseScore + timeBonus - hintPenalty + comboBonus) * levelMultiplier);
    }

    function updateScore(points) {
        gameScore += points;
        totalScore += points;
        $('currentScore').textContent = gameScore;
        saveProgress();
    }

    function checkCombo() {
        const now = Date.now();
        if (now - lastWordTime < 5000) {
            comboCount++;
            if (comboCount >= 3) {
                showCombo();
                sounds.combo();
                updateScore(comboCount * 25);
            }
            $('comboDisplay').style.display = 'inline-flex';
            $('comboCount').textContent = comboCount;
        } else {
            comboCount = 1;
        }
        lastWordTime = now;
    }

    function showCombo() {
        const comboBadge = document.createElement('div');
        comboBadge.className = 'combo-badge';
        comboBadge.textContent = `üî• COMBO x${comboCount}!`;
        document.body.appendChild(comboBadge);
        setTimeout(() => comboBadge.remove(), 1000);
    }

    function checkAchievements() {
        const newAchievements = [];
        if (hintsRemaining === 3 && found.size === placedWords.length) {
            newAchievements.push({ icon: 'üß†', title: 'G√™nio', desc: 'Completou sem usar dicas!' });
        }
        if (!isZenMode && gameScore >= 5000) {
            newAchievements.push({ icon: '‚ö°', title: 'Velocista', desc: 'Mais de 5000 pontos!' });
        }
        if (comboCount >= 5) {
            newAchievements.push({ icon: 'üî•', title: 'Combo Master', desc: '5 palavras seguidas!' });
        }
        const accuracy = totalSelections > 0 ? (correctSelections / totalSelections * 100) : 100;
        if (accuracy === 100 && totalSelections >= 5) {
            newAchievements.push({ icon: 'üéØ', title: 'Perfeccionista', desc: '100% de precis√£o!' });
        }
        newAchievements.forEach(ach => {
            if (!achievements.find(a => a.title === ach.title)) {
                achievements.push(ach);
                showAchievement(ach);
            }
        });
        displayAchievements();
        saveProgress();
    }

    function showAchievement(achievement) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.background = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
        toast.innerHTML = `<strong>${achievement.icon} ${achievement.title}</strong><br>${achievement.desc}`;
        document.body.appendChild(toast);
        sounds.levelUp();
        setTimeout(() => toast.remove(), 4000);
    }

    function displayAchievements() {
        const container = $('achievementsDisplay');
        if (achievements.length === 0) {
            container.innerHTML = '';
            return;
        }
        container.innerHTML = '<div style="margin-bottom:10px;font-weight:600;color:var(--primary)">üèÜ Conquistas:</div>' +
            achievements.map(ach => `<span class="achievement-badge">${ach.icon} ${ach.title}</span>`).join('');
    }

    function saveGameHistory(data) {
        try {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            history.unshift({...data, date: new Date().toISOString()});
            if (history.length > 50) history.pop();
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        } catch (e) {
            console.error('Erro ao salvar hist√≥rico:', e);
        }
    }

    function loadGameHistory() {
        try {
            return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        } catch (e) {
            return [];
        }
    }

    function loadHistoryModal() {
        const history = loadGameHistory();
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.id = 'historyModal';
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <button class="modal-close" onclick="closeModal('historyModal')">√ó</button>
            <h2>üìú Hist√≥rico de Partidas</h2>
            <div style="margin-bottom:15px;display:flex;gap:10px;justify-content:center">
                <button onclick="clearHistoryModal()" style="background:var(--danger);color:white;padding:8px 16px;border-radius:8px;cursor:pointer">üóëÔ∏è Limpar Hist√≥rico</button>
            </div>
            ${history.length === 0 ? `
                <div class="empty-state">
                    <div class="empty-state-icon">üéÆ</div>
                    <h3 style="color:var(--muted)">Nenhuma partida registrada ainda</h3>
                    <p style="color:var(--muted);margin-top:10px">Jogue uma partida para ver seu hist√≥rico aqui!</p>
                </div>
            ` : `
                <ul class="history-list">
                    ${history.map(game => {
                        const date = new Date(game.date);
                        const dateStr = date.toLocaleDateString('pt-BR');
                        const timeStr = date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                        const levelInfo = GAME_LEVELS[game.level] || GAME_LEVELS[0];
                        const completionClass = game.completed ? 'complete' : 'incomplete';
                        const completionText = game.completed ? '‚úÖ Completo' : (game.foundWords > 0 ? '‚ö†Ô∏è Incompleto' : '‚ùå Desistiu');
                        const stars = game.stars || 0;
                        const starsDisplay = '‚≠ê'.repeat(stars).padEnd(3, '‚òÜ');
                        const playerName = game.playerName || 'Desconhecido';
                        return `
                            <li class="history-item ${completionClass}">
                                <div class="history-icon">${game.completed ? '‚úÖ' : '‚ùå'}</div>
                                <div class="history-info">
                                    <h4>${levelInfo.title}</h4>
                                    <p>${playerName} ‚Ä¢ ${game.foundWords}/${game.totalWords} palavras ‚Ä¢ ${game.score || 0} pts ‚Ä¢ ${completionText}
                                        ${game.zenMode ? ' ‚Ä¢ <span class="zen-badge" style="font-size:0.8rem;padding:3px 8px">üßò Zen</span>' : ''}
                                        <br><span class="stars">${starsDisplay}</span>
                                    </p>
                                    <p style="font-size:0.85rem">${dateStr} √†s ${timeStr}</p>
                                </div>
                                <div class="history-time">${game.zenMode ? '_FILENO' : game.time ? game.time.toFixed(2) + 's' : '-'}</div>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `}
        `;
        overlay.appendChild(modal);
        $('modalContainer').appendChild(overlay);
    }

    function clearHistoryModal() {
        if (confirm('üóëÔ∏è Deseja realmente limpar todo o hist√≥rico de partidas?')) {
            localStorage.removeItem(HISTORY_KEY);
            closeModal('historyModal');
            showToast('üóëÔ∏è Hist√≥rico limpo com sucesso!', 'success');
        }
    }

    function saveProgress() {
        try {
            localStorage.setItem(PROGRESS_KEY, JSON.stringify({currentLevel, unlockedLevels, totalScore, achievements, correctSelections, totalSelections}));
        } catch (e) {
            console.error('Erro ao salvar progresso:', e);
        }
    }

    function loadProgress() {
        try {
            const progress = JSON.parse(localStorage.getItem(PROGRESS_KEY) || '{}');
            if (progress.unlockedLevels) unlockedLevels = progress.unlockedLevels;
            if (progress.totalScore) totalScore = progress.totalScore;
            if (progress.achievements) achievements = progress.achievements;
            if (progress.correctSelections) correctSelections = progress.correctSelections;
            if (progress.totalSelections) totalSelections = progress.totalSelections;
            return progress;
        } catch (e) {
            return {};
        }
    }

    function showLevelSelector() {
        if (isPaused) {
            showToast('‚ö†Ô∏è Despause o jogo para ver os n√≠veis!', 'warning');
            sounds.error();
            return;
        }
        pauseGame();
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.id = 'levelModal';
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.maxWidth = '900px';
        const categories = {
            infantil: { name: 'Infantil', icon: 'üë∂', levels: [] },
            brasil: { name: 'Brasil', icon: 'üáßüá∑', levels: [] },
            tecnologia: { name: 'Tecnologia', icon: 'üíª', levels: [] },
            mundo: { name: 'Mundo', icon: 'üåç', levels: [] },
            biblia: { name: 'B√≠blia', icon: 'üôè', levels: [] },
            natureza: { name: 'Natureza', icon: 'üåø', levels: [] },
            extremo: { name: 'Extremo', icon: 'üî•', levels: [] }
        };
        GAME_LEVELS.forEach((level, index) => {
            if (categories[level.category]) {
                categories[level.category].levels.push({ ...level, index });
            }
        });
        modal.innerHTML = `
            <button class="modal-close" onclick="closeModal('levelModal')">√ó</button>
            <h2>üéØ Selecione o N√≠vel</h2>
            <div style="text-align:center;margin-bottom:20px">
                <label style="display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer">
                    <input type="checkbox" id="zenModeCheckbox" ${isZenMode ? 'checked' : ''} 
                           onchange="toggleZenMode(this.checked)" 
                           style="width:20px;height:20px;cursor:pointer">
                    <span style="font-size:1.1rem">üßò Modo Zen (Sem Cron√¥metro)</span>
                </label>
            </div>
            ${Object.entries(categories).map(([key, cat]) => {
                if (cat.levels.length === 0) return '';
                return `
                    <div class="category-section">
                        <div class="category-title">${cat.icon} ${cat.name}</div>
                        <div class="level-grid" style="grid-template-columns:repeat(auto-fit, minmax(200px, 1fr))">
                            ${cat.levels.map(level => {
                                const isLocked = level.index >= unlockedLevels;
                                const difficultyClass = level.difficulty.toLowerCase().replace(/\s+/g, '-');
                                return `
                                    <div class="level-card ${isLocked ? 'locked' : ''}" 
                                         onclick="${isLocked ? '' : `selectLevel(${level.index})`}" 
                                         style="border-color:${level.color}">
                                        <div style="font-size:2.5rem;margin-bottom:10px">${isLocked ? 'üîí' : level.icon}</div>
                                        <h3 style="margin:10px 0;color:var(--primary);font-size:1rem">${level.title.split(':')[1]}</h3>
                                        <div class="level-difficulty difficulty-${difficultyClass}">${level.difficulty}</div>
                                        <p style="color:var(--muted);font-size:0.85rem;margin-top:10px">${level.words.length} palavras ‚Ä¢ Grade ${level.size}x${level.size}</p>
                                        ${isLocked ? '<p style="color:var(--warning);margin-top:10px;font-size:0.85rem">Complete o n√≠vel anterior</p>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('')}
        `;
        overlay.appendChild(modal);
        $('modalContainer').appendChild(overlay);
    }

    function selectLevel(levelIndex) {
        closeModal('levelModal');
        handleLevelEnd(false, true);
        currentLevel = levelIndex;
        resetGameSession();
        initGame(currentLevel);
        showToast(`üéÆ ${GAME_LEVELS[levelIndex].title} iniciado!`, 'success');
        sounds.click();
        if (!isZenMode) startTimer();
        if (currentLevel !== 0) {
            currentRowId = null;
        }
    }

    function toggleZenMode(enabled) {
        isZenMode = enabled;
        if (enabled) {
            $('zenBadge').style.display = 'inline-flex';
            stopTimer();
            $('timeDisplay').textContent = '_FILENO Zen';
        } else {
            $('zenBadge').style.display = 'none';
            if (startTime) startTimer();
        }
        showToast(enabled ? 'üßò Modo Zen Ativado' : '‚è±Ô∏è Cron√¥metro Ativado', 'success');
        sounds.click();
    }

    function closeModal(modalId) {
        const modal = $(modalId);
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => modal.remove(), 300);
        }
    }

    window.closeModal = closeModal;
    window.clearHistoryModal = clearHistoryModal;
    window.selectLevel = selectLevel;
    window.toggleZenMode = toggleZenMode;

    function showTutorial() {
        const overlay = document.createElement('div');
        overlay.className = 'tutorial-overlay';
        overlay.id = 'tutorialOverlay';
        const content = document.createElement('div');
        content.className = 'tutorial-content';
        content.innerHTML = `
            <h2 style="font-size:2rem;margin-bottom:20px">üéØ Como Jogar</h2>
            <div class="tutorial-step">
                <h3 style="color:var(--primary);margin-bottom:10px">1Ô∏è‚É£ Encontre as Palavras</h3>
                <p style="color:var(--muted)">Clique na primeira letra e depois na √∫ltima letra da palavra. As palavras podem estar na horizontal, vertical ou diagonal!</p>
            </div>
            <div class="tutorial-step">
                <h3 style="color:var(--primary);margin-bottom:10px">2Ô∏è‚É£ Ganhe Pontos</h3>
                <p style="color:var(--muted)">Encontre palavras rapidamente para ganhar b√¥nus de tempo. Use menos dicas para mais pontos!</p>
            </div>
            <div class="tutorial-step">
                <h3 style="color:var(--primary);margin-bottom:10px">3Ô∏è‚É£ Fa√ßa Combos</h3>
                <p style="color:var(--muted)">Encontre palavras em menos de 5 segundos uma da outra para ativar combos e ganhar pontos extras!</p>
            </div>
            <div class="tutorial-step">
                <h3 style="color:var(--primary);margin-bottom:10px">‚å®Ô∏è Atalhos do Teclado</h3>
                <p style="color:var(--muted)"><strong>ESC</strong> - Pausar/Retomar<br><strong>H</strong> - Usar Dica<br><strong>F</strong> - Tela Cheia</p>
            </div>
            <button onclick="closeTutorial()" style="margin-top:20px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;padding:15px 40px;border-radius:12px;font-size:1.1rem;border:none;cursor:pointer;width:100%">
                ‚úÖ Entendi, Vamos Jogar!
            </button>
        `;
        overlay.appendChild(content);
        document.body.appendChild(overlay);
        overlay.style.zIndex = 1002;
    }

    function closeTutorial() {
        const tutorial = $('tutorialOverlay');
        if (tutorial) tutorial.remove();
        localStorage.setItem('tutorial_shown', 'true');
    }

    window.closeTutorial = closeTutorial;

    function nowLocalDateTimeForInput(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60000);
      return local.toISOString().slice(0,16);
    }

    async function postData(data) {
      try {
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 
            'Content-Type': 'application/json'
          }, 
          body: JSON.stringify(data)
        });
        return data.type === 'registerAndGame' ? { status: 'success', message: 'Enviado', rowId: Math.random().toString(36).substring(2, 9) } : { status: 'success', message: 'Enviado' };
      } catch (error) {
        console.error('Erro ao enviar dados:', error);
        showToast('‚ö†Ô∏è Erro ao enviar para planilha (verifique console)', 'error');
        return { status: 'error', message: error.message };
      }
    }

    function loadEntries(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        console.error('Erro ao carregar entradas:', e);
        return [];
      }
    }

    function saveEntries(arr){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      }catch(e){
        console.error('Erro ao salvar entradas:', e);
      }
    }

    function updateUIEntries(){
      const arr = loadEntries();
      $('totalCount').textContent = arr.length;
      if(arr.length === 0){
        $('lastEntries').textContent = 'Nenhum ainda';
      } else {
        $('lastEntries').textContent = arr.slice(-3).map(r => `${r.nome} (${r.datetime.split('T')[0] || r.datetime})`).join(' ‚Ä¢ ');
      }
    }

    async function loadLeaderboard(target = 'initial'){
        const history = loadGameHistory();
        hasCompletedLevelOne = history.some(g => g.level === 0 && g.completed);
        const statusEl = target === 'initial' ? $('leaderboardStatus') : $('resultsLeaderboardStatus');
        const listEl = target === 'initial' ? $('leaderboardList') : $('resultsLeaderboardList');
        if (!hasCompletedLevelOne) {
            statusEl.textContent = '‚ö†Ô∏è Conclua o N√≠vel 1 para entrar no Ranking Nacional!';
            listEl.innerHTML = '<li class="leaderboard-item">Ranking indispon√≠vel at√© a conclus√£o do primeiro n√≠vel.</li>';
            return;
        }
        statusEl.textContent = '‚è≥ Carregando ranking...';
        listEl.innerHTML = '<li class="leaderboard-item">Carregando...</li>';
        try {
            const response = await fetch(APPS_SCRIPT_URL + '?type=getLeaderboard');
            const data = await response.json();
            if(data.leaderboard && data.leaderboard.length > 0) {
                statusEl.textContent = 'üèÜ Top Jogadores do Brasil';
                listEl.innerHTML = data.leaderboard.map((player, index) => `
                    <li class="leaderboard-item">
                        <span class="name">${index + 1}¬∫ - ${player.nome}</span>
                        <div>
                            <span class="time">${player.tempo}s</span>
                            <span class="score-display" style="margin-left:15px">${player.pontos || 0} pts</span>
                        </div>
                    </li>
                `).join('');
            } else {
                statusEl.textContent = 'üéÆ Nenhum jogador ainda';
                listEl.innerHTML = '<li class="leaderboard-item">Seja o primeiro a completar um n√≠vel!</li>';
            }
        } catch (error) {
            console.error('Erro ao carregar ranking:', error);
            statusEl.textContent = 'üìä Ranking em Constru√ß√£o';
            listEl.innerHTML = '<li class="leaderboard-item">O ranking ser√° atualizado ap√≥s os primeiros jogos. Continue jogando!</li>';
        }
    }

    function showToast(message, type = 'success'){
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        if(type === 'error') toast.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        if(type === 'warning') toast.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function createParticles(x, y){
        const container = document.createElement('div');
        container.className = 'particles';
        container.style.left = x + 'px';
        container.style.top = y + 'px';
        for(let i = 0; i < 12; i++){
            const particle = document.createElement('div');
            particle.className = 'particle';
            const angle = (Math.PI * 2 * i) / 12;
            const distance = 50 + Math.random() * 50;
            particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
            particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
            particle.style.background = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'][Math.floor(Math.random() * 5)];
            container.appendChild(particle);
        }
        document.body.appendChild(container);
        setTimeout(() => container.remove(), 1000);
    }

    function createConfetti() {
        for(let i = 0; i < 50; i++){
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * window.innerWidth + 'px';
                confetti.style.top = -20 + 'px';
                confetti.style.background = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#fbbf24'][Math.floor(Math.random() * 6)];
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }, i * 30);
        }
    }

    function startTimer(){
        if(isZenMode) {
            $('timeDisplay').textContent = '_FILENO Zen';
            return;
        }
        if(timerInterval) clearInterval(timerInterval);
        startTime = Date.now() - pausedTime;
        timerInterval = setInterval(() => {
            if(!isPaused){
                const elapsed = (Date.now() - startTime) / 1000;
                $('timeDisplay').textContent = elapsed.toFixed(2) + 's';
            }
        }, 100);
    }

    function stopTimer(){
        if(timerInterval){
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    function pauseGame(){
        if(isPaused) return;
        isPaused = true;
        if (!isZenMode) {
            pausedTime = Date.now() - startTime;
            stopTimer();
        }
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.id = 'pauseOverlay';
        overlay.innerHTML = `
            <div class="modal">
                <h2 style="font-size:2rem;margin-bottom:20px">‚è∏Ô∏è JOGO PAUSADO</h2>
                <p style="color:var(--muted);margin-bottom:30px">Clique para continuar</p>
                <button style="padding:15px 40px;font-size:1.1rem;background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;border:none;border-radius:12px;cursor:pointer" onclick="resumeGame()">‚ñ∂Ô∏è Continuar Jogo</button>
            </div>
        `;
        $('modalContainer').appendChild(overlay);
        $('pauseBtn').textContent = '‚ñ∂Ô∏è Continuar';
        sounds.click();
    }

    function resumeGame(){
        if(!isPaused) return;
        isPaused = false;
        const overlay = $('pauseOverlay');
        if(overlay) overlay.remove();
        if (!isZenMode) startTimer();
        $('pauseBtn').textContent = '‚è∏Ô∏è Pausar';
        showToast('‚ñ∂Ô∏è Jogo retomado!', 'success');
        sounds.click();
    }

    function handleLevelEnd(completed, changingLevel = false) {
        stopTimer();
        const timeTakenSeconds = isZenMode ? 0 : ((Date.now() - startTime) / 1000);
        lastLevelTimeTaken = timeTakenSeconds;
        const currentLevelData = GAME_LEVELS[currentLevel];
        const levelScore = completed ? calculateScore(timeTakenSeconds, 3 - hintsRemaining, currentLevel) : 0;
        const accuracy = totalSelections > 0 ? (correctSelections / totalSelections * 100) : 100;
        playerStars = completed ? calculateStars(timeTakenSeconds, 3 - hintsRemaining, accuracy) : 0;
        if (completed) {
            updateScore(levelScore);
            checkAchievements();
            if (currentLevel + 1 > unlockedLevels) {
                unlockedLevels = currentLevel + 1;
                saveProgress();
            }
        }
        const playerNameToSave = currentUserName || 'Desconhecido';
        saveGameHistory({
            level: currentLevel,
            playerName: playerNameToSave,
            foundWords: found.size,
            totalWords: placedWords.length,
            time: timeTakenSeconds,
            completed: completed,
            zenMode: isZenMode,
            score: levelScore,
            stars: playerStars
        });
        if (completed && currentLevel === 0 && !isZenMode && currentRowId) {
            const gameData = {
                type: 'gameFinished',
                rowId: currentRowId,
                foundCount: found.size,
                timeTakenSeconds: parseFloat(timeTakenSeconds.toFixed(2)),
                playerName: playerNameToSave,
                score: totalScore,
                completed: true,
                stars: playerStars
            };
            postData(gameData).then(() => {
                loadLeaderboard();
            }).catch(err => {
                console.error('Erro ao enviar resultado:', err);
            });
            currentRowId = null;
            hasCompletedLevelOne = true;
        } else if (!completed && currentLevel === 0 && currentRowId) {
            currentRowId = null;
        }
        if (!changingLevel) {
            setTimeout(() => {
                showScreen('resultsScreen');
            }, 1000);
        }
    }

    function skipLevel() {
        if (isPaused) return;
        if (!confirm('‚è≠Ô∏è Tem certeza que deseja pular este n√≠vel? Voc√™ n√£o receber√° pontos!')) {
            return;
        }
        handleLevelEnd(false, true);
        const nextLevel = currentLevel + 1;
        if (nextLevel < GAME_LEVELS.length) {
            currentLevel = nextLevel;
            if(currentLevel >= unlockedLevels) {
                unlockedLevels = currentLevel + 1;
                saveProgress();
            }
            initGame(currentLevel);
            resetGameSession();
            showToast(`‚è≠Ô∏è N√≠vel pulado. Iniciando N√≠vel ${currentLevel + 1}!`, 'warning');
            sounds.click();
        } else {
            showToast(`üéâ Voc√™ pulou todos os n√≠veis. Fim de Jogo!`, 'success');
            sounds.levelUp();
            setTimeout(() => {
                showScreen('resultsScreen');
            }, 2000);
        }
    }

    function giveUpGame() {
        if (isPaused) return;
        if (!confirm('‚ùå Tem certeza que deseja desistir deste n√≠vel? Voc√™ perder√° o progresso do n√≠vel!')) {
            return;
        }
        handleLevelEnd(false, false);
        showToast(`‚ùå N√≠vel desistido. Veja seus resultados.`, 'error');
        sounds.error();
    }

    function endGame() {
        if (isPaused) return;
        if (!confirm('‚èπÔ∏è Deseja finalizar o jogo e retornar para a tela de resultados?')) {
            return;
        }
        handleLevelEnd(false, false);
        showToast('‚èπÔ∏è Jogo finalizado. Resultados!', 'success');
        sounds.click();
    }

    function giveHint(){
        if(isPaused) return;
        if(hintsRemaining <= 0){
            showToast('‚ö†Ô∏è Sem dicas dispon√≠veis!', 'warning');
            sounds.error();
            return;
        }
        const notFound = placedWords.filter(pw => !found.has(pw.word) && !pw.notPlaced);
        if(notFound.length === 0) return;
        const randomWord = notFound[Math.floor(Math.random() * notFound.length)];
        const firstCell = document.querySelector(`.cell[data-r='${randomWord.r}'][data-c='${randomWord.c}']`);
        if(firstCell){
            firstCell.style.background = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
            firstCell.style.transform = 'scale(1.3)';
            firstCell.style.color = 'white';
            setTimeout(() => {
                firstCell.style.background = '';
                firstCell.style.transform = '';
                firstCell.style.color = '';
            }, 2000);
            hintsRemaining--;
            $('hintCount').textContent = hintsRemaining;
            showToast(`üí° Dica: Procure por "${randomWord.word}"`, 'warning');
            sounds.click();
            if(hintsRemaining === 0){
                $('hintBtn').disabled = true;
                $('hintBtn').style.opacity = '0.5';
            }
        }
    }

    function resetGameSession() {
        hintsRemaining = 3;
        gameScore = 0;
        comboCount = 0;
        lastWordTime = 0;
        $('hintCount').textContent = hintsRemaining;
        $('currentScore').textContent = gameScore;
        $('hintBtn').disabled = false;
        $('hintBtn').style.opacity = '1';
        $('comboDisplay').style.display = 'none';
        $('comboCount').textContent = '0';
        isPaused = false;
        pausedTime = 0;
        if (!isZenMode) startTimer();
    }

    document.addEventListener('keydown', (e) => {
        if(!$('gameScreen') || !$('gameScreen').classList.contains('active')) return;
        if(e.key === 'Escape') {
            e.preventDefault();
            if(isPaused) resumeGame();
            else pauseGame();
        }
        if(e.key === 'h' || e.key === 'H') {
            e.preventDefault();
            giveHint();
        }
        if(e.key === 'f' || e.key === 'F') {
            e.preventDefault();
            toggleFullscreen();
        }
    });

    document.addEventListener('visibilitychange', () => {
        if(document.hidden && !isPaused && $('gameScreen').classList.contains('active')) {
            pauseGame();
        }
    });

    function openGame(nome, registered = false) {
        showScreen('gameScreen');
        currentUserName = nome;
        currentLevel = 0;
        totalScore = 0;
        resetGameSession();
        sessionStart = Date.now();
        if (isZenMode) $('zenBadge').style.display = 'inline-flex';
        startTimer();
        initGame(currentLevel);
        displayAchievements();
        showToast('üéÆ Jogo iniciado! Boa sorte!', 'success');
        sounds.levelUp();
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadTheme();
        loadProgress();
        const soundSaved = localStorage.getItem(SOUND_KEY);
        soundEnabled = soundSaved !== 'false';
        $('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
        $('datetime').value = nowLocalDateTimeForInput();
        updateUIEntries();
        loadLeaderboard();
        if(!localStorage.getItem('tutorial_shown')) {
            setTimeout(showTutorial, 1000);
        }
        $('themeToggle').addEventListener('click', toggleTheme);
        $('soundToggle').addEventListener('click', toggleSound);
        $('fullscreenToggle').addEventListener('click', toggleFullscreen);
        $('historyBtnInitial').addEventListener('click', loadHistoryModal);
        $('statsBtnInitial').addEventListener('click', () => showScreen('resultsScreen'));
        $('clearBtnInitial').addEventListener('click', () => {
             if(confirm('‚ùå Apagar todos os registros do navegador?\nSeus dados locais ser√£o removidos permanentemente. Isso inclui nome, hist√≥rico e progresso.')){
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(PROGRESS_KEY);
                localStorage.removeItem(HISTORY_KEY);
                updateUIEntries();
                showToast('üóëÔ∏è Dados locais removidos', 'success');
                sounds.click();
                loadResultsScreen();
             }
        });
        $('refreshLeaderboard').addEventListener('click', () => loadLeaderboard('initial'));
        $('cadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = $('nome').value.trim();
            const dob = $('dob').value;
            const datetime = $('datetime').value;
            if(!nome || !datetime){
                showToast('‚ö†Ô∏è Preencha nome e data/hora', 'error');
                if(soundEnabled) sounds.error();
                return;
            }
            const arr = loadEntries();
            arr.push({nome, dob: dob || 'N√£o informado', datetime});
            saveEntries(arr);
            updateUIEntries();
            const dataToSend = { 
                type: 'registerAndGame', 
                nome, 
                dob: dob || 'N√£o informado', 
                datetime 
            };
            showToast('üì§ Enviando dados para planilha...', 'warning');
            try {
                const result = await postData(dataToSend);
                if(result && result.rowId) {
                    currentRowId = result.rowId;
                    showToast('‚úÖ Dados enviados! Jogo iniciado!', 'success');
                } else {
                    currentRowId = `local_${Date.now()}`;
                    showToast('‚ö†Ô∏è Dados salvos localmente. Verifique planilha.', 'warning');
                }
            } catch(error) {
                console.error('Erro ao enviar dados:', error);
                showToast('‚ö†Ô∏è Erro no envio. Dados salvos localmente.', 'warning');
                currentRowId = `local_${Date.now()}`;
            }
            openGame(nome, true);
            $('cadForm').reset();
            $('datetime').value = nowLocalDateTimeForInput();
            if(soundEnabled) sounds.success();
        });
        $('openGameBtn').addEventListener('click', () => {
            openGame('Desconhecido', false);
            sounds.click();
        });
        $('pauseBtn').addEventListener('click', () => {
            if(isPaused) resumeGame();
            else pauseGame();
        });
        $('hintBtn').addEventListener('click', giveHint);
        $('skipLevelBtn').addEventListener('click', skipLevel);
        $('giveUpBtn').addEventListener('click', giveUpGame);
        $('endGameBtn').addEventListener('click', endGame);
        $('levelsBtn').addEventListener('click', () => {
            showLevelSelector();
            sounds.click();
        });
        $('refreshLeaderboardResults').addEventListener('click', () => loadLeaderboard('results'));
        $('shareResultsBtn').addEventListener('click', shareResults);
        showScreen('registerScreen');
    });

    window.resumeGame = resumeGame;
    window.startNewGameFromResults = startNewGameFromResults;
    window.showScreen = showScreen;

    function initGame(levelIndex){
        const level = GAME_LEVELS[levelIndex];
        GRID_SIZE = level.size;
        WORDS = level.words.map(w => w.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""));
        $('gameTitle').textContent = level.title;
        $('levelDisplay').textContent = `N√≠vel ${levelIndex + 1}`;
        found.clear();
        selection = null;
        placedWords = [];
        grid = Array.from({length: GRID_SIZE}, () => Array.from({length: GRID_SIZE}, () => ' '));
        const list = WORDS.slice();
        for(const w of list) placeWord(w);
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        for(let r = 0; r < GRID_SIZE; r++){
            for(let c = 0; c < GRID_SIZE; c++){
                if(grid[r][c] === ' '){
                    grid[r][c] = letters.charAt(Math.floor(Math.random() * letters.length));
                }
            }
        }
        renderGrid();
        renderWords();
        updateFoundCount();
        updateProgressBar();
        updateAccuracy();
    }

    function placeWord(word){
        const w = word.toUpperCase();
        const directions = [[0,1], [1,0], [1,1], [-1,1], [0,-1], [-1,0], [-1,-1], [1,-1]];
        const maxAttempts = 1000;
        for(let attempt = 0; attempt < maxAttempts; attempt++){
            const dir = directions[Math.floor(Math.random() * directions.length)];
            const len = w.length;
            const r = Math.floor(Math.random() * GRID_SIZE);
            const c = Math.floor(Math.random() * GRID_SIZE);
            const endR = r + dir[0] * (len - 1);
            const endC = c + dir[1] * (len - 1);
            if(endR < 0 || endR >= GRID_SIZE || endC < 0 || endC >= GRID_SIZE) continue;
            let ok = true;
            for(let i = 0; i < len; i++){
                const rr = r + dir[0] * i;
                const cc = c + dir[1] * i;
                const ch = grid[rr][cc];
                if(ch !== ' ' && ch !== w[i]){
                    ok = false;
                    break;
                }
            }
            if(!ok) continue;
            for(let i = 0; i < len; i++){
                const rr = r + dir[0] * i;
                const cc = c + dir[1] * i;
                grid[rr][cc] = w[i];
            }
            placedWords.push({word: w, r, c, dr: dir[0], dc: dir[1], len});
            return true;
        }
        const fallbacks = ['ELSA', 'JASMIM', 'MOANA', 'MERIDA', 'TIANA'];
        for (const fb of fallbacks) {
            if (placeWord(fb)) {
                placedWords[placedWords.length - 1].original = word;
                return true;
            }
        }
        placedWords.push({word: w, notPlaced: true});
        return false;
    }

    function renderGrid(){
        const wrap = $('gridWrap');
        wrap.innerHTML = '';
        const g = document.createElement('div');
        g.className = 'grid';
        g.style.gridTemplateColumns = `repeat(${GRID_SIZE}, auto)`;
        for(let r = 0; r < GRID_SIZE; r++){
            for(let c = 0; c < GRID_SIZE; c++){
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.r = r;
                cell.dataset.c = c;
                cell.textContent = grid[r][c];
                cell.addEventListener('click', onCellClick);
                g.appendChild(cell);
            }
        }
        wrap.appendChild(g);
        refreshHighlights();
    }

    function renderWords(){
        const node = $('words');
        node.innerHTML = '';
        const currentLevelData = GAME_LEVELS[currentLevel];
        for(const w of currentLevelData.words){
            const clean = w.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const idKey = 'word_' + clean;
            const div = document.createElement('div');
            div.className = 'word';
            div.textContent = w.toUpperCase();
            div.id = idKey;
            div.setAttribute('aria-label', 'Palavra: ' + w);
            node.appendChild(div);
        }
    }

    function onCellClick(e){
        if(isPaused) return;
        const r = parseInt(e.currentTarget.dataset.r, 10);
        const c = parseInt(e.currentTarget.dataset.c, 10);
        if(!selection){
            selection = {r1: r, c1: c};
            sounds.click();
        } else {
            selection.r2 = r;
            selection.c2 = c;
            checkSelection();
            selection = null;
        }
        refreshHighlights();
    }

    function refreshHighlights(){
        document.querySelectorAll('.cell').forEach(el => {
            el.classList.remove('selecting', 'found');
        });
        if(selection){
            const s = selection;
            const start = document.querySelector(`.cell[data-r='${s.r1}'][data-c='${s.c1}']`);
            if(start) start.classList.add('selecting');
        }
        for(const f of found){
            const pw = placedWords.find(p => p.word === f);
            if(!pw || pw.notPlaced) continue;
            for(let i = 0; i < pw.len; i++){
                const rr = pw.r + pw.dr * i;
                const cc = pw.c + pw.dc * i;
                const el = document.querySelector(`.cell[data-r='${rr}'][data-c='${cc}']`);
                if(el) el.classList.add('found');
            }
            const wel = $('word_' + pw.word);
            if(wel) wel.classList.add('found');
        }
    }

    function checkSelection(){
        if(!selection || selection.r2 === undefined) return;
        totalSelections++;
        const r1 = selection.r1, c1 = selection.c1, r2 = selection.r2, c2 = selection.c2;
        const dr = Math.sign(r2 - r1);
        const dc = Math.sign(c2 - c1);
        const lenR = Math.abs(r2 - r1) + 1;
        const lenC = Math.abs(c2 - c1) + 1;
        const len = Math.max(lenR, lenC);
        if(lenR !== 1 && lenC !== 1 && lenR !== lenC){
            flashSelection(r1, c1, r2, c2);
            updateAccuracy();
            sounds.error();
            return;
        }
        let s = '';
        for(let i = 0; i < len; i++){
            const rr = r1 + dr * i;
            const cc = c1 + dc * i;
            if(rr < 0 || rr >= GRID_SIZE || cc < 0 || cc >= GRID_SIZE) break;
            s += grid[rr][cc];
        }
        const rev = s.split('').reverse().join('');
        const matched = placedWords.find(p => (p.word === s || p.word === rev) && !found.has(p.word));
        if(matched){
            correctSelections++;
            found.add(matched.word);
            const firstCell = document.querySelector(`.cell[data-r='${matched.r}'][data-c='${matched.c}']`);
            if(firstCell){
                const rect = firstCell.getBoundingClientRect();
                createParticles(rect.left + rect.width / 2, rect.top + rect.height / 2);
            }
            checkCombo();
            const wordPoints = 100 + (matched.word.length * 10);
            updateScore(wordPoints);
            updateFoundCount();
            updateProgressBar();
            updateAccuracy();
            refreshHighlights();
            showToast(`‚úÖ Palavra encontrada: ${matched.word} (+${wordPoints} pts)`, 'success');
            sounds.success();
            checkWin();
        } else {
            flashSelection(r1, c1, r2, c2);
            updateAccuracy();
            sounds.error();
        }
    }

    function flashSelection(r1, c1, r2, c2){
        const dr = Math.sign(r2 - r1);
        const dc = Math.sign(c2 - c1);
        const len = Math.max(Math.abs(r2 - r1) + 1, Math.abs(c2 - c1) + 1);
        const cells = [];
        for(let i = 0; i < len; i++){
            const rr = r1 + dr * i;
            const cc = c1 + dc * i;
            const el = document.querySelector(`.cell[data-r='${rr}'][data-c='${cc}']`);
            if(el){
                el.classList.add('selecting');
                cells.push(el);
            }
        }
        setTimeout(() => cells.forEach(el => el.classList.remove('selecting')), 400);
    }

    function updateFoundCount(){
        $('foundCount').textContent = `${found.size} / ${placedWords.length}`;
    }

    function updateProgressBar(){
        const progress = (found.size / placedWords.length) * 100;
        $('progressFill').style.width = progress + '%';
    }

    function updateAccuracy(){
        const accuracy = totalSelections > 0 ? (correctSelections / totalSelections * 100).toFixed(1) : 100;
        $('accuracyDisplay').textContent = accuracy + '%';
    }

    function checkWin(){
        if(found.size === placedWords.length){
            moveToNextLevel();
        }
    }

    function moveToNextLevel(){
        handleLevelEnd(true, true);
        currentLevel++;
        if(currentLevel < GAME_LEVELS.length){
            showToast(`üéâ N√≠vel ${currentLevel} completo! Partiu N√≠vel ${currentLevel + 1}!`, 'success');
            createConfetti();
            sounds.levelUp();
            setTimeout(() => {
                initGame(currentLevel);
                resetGameSession();
            }, 2000);
        } else {
            showToast(`üèÜ PARAB√âNS! Voc√™ completou todos os n√≠veis!`, 'success');
            createConfetti();
            sounds.levelUp();
            stopTimer();
            setTimeout(() => {
                showScreen('resultsScreen');
            }, 2000);
        }
    }

    async function shareResults() {
        const element = $('resultsScreen');
        if (!element) return;
        try {
            const canvas = await html2canvas(element, { scale: 1 });
            canvas.toBlob(async (blob) => {
                if (navigator.share && navigator.canShare({ files: [new File([blob], 'resultado.png', { type: 'image/png' })] })) {
                    await navigator.share({
                        title: 'Meu Resultado no Ca√ßa-Palavras!',
                        text: 'Veja meu desempenho!',
                        files: [new File([blob], 'resultado.png', { type: 'image/png' })]
                    });
                } else {
                    const url = canvas.toDataURL();
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ca√ßapalavras_resultado.png';
                    a.click();
                    showToast('‚úÖ Imagem salva!', 'success');
                }
            }, 'image/png');
        } catch (e) {
            console.error('Erro ao gerar imagem:', e);
            showToast('‚ö†Ô∏è N√£o foi poss√≠vel gerar imagem.', 'error');
        }
    }

    const manifest = document.getElementById('inline-manifest');
    const blob = new Blob([manifest.textContent], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = url;
    document.head.appendChild(link);
  </script>
</body>
</html>


